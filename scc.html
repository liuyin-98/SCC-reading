<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Markmap</title>
<style>
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/style.css">
</head>
<body>
<svg id="mindmap"></svg>
<script src="https://cdn.jsdelivr.net/npm/d3@6.7.0"></script><script src="https://cdn.jsdelivr.net/npm/markmap-view@0.2.7"></script><script>(getMarkmap => {
          window.WebFontConfig = {
            custom: {
              families: ['KaTeX_AMS', 'KaTeX_Caligraphic:n4,n7', 'KaTeX_Fraktur:n4,n7', 'KaTeX_Main:n4,n7,i4,i7', 'KaTeX_Math:i4,i7', 'KaTeX_Script', 'KaTeX_SansSerif:n4,n7,i4', 'KaTeX_Size1', 'KaTeX_Size2', 'KaTeX_Size3', 'KaTeX_Size4', 'KaTeX_Typewriter']
            },
            active: () => {
              getMarkmap().refreshHook.call();
            }
          };
        })(() => window.markmap)</script><script src="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.js" defer></script><script src="https://cdn.jsdelivr.net/npm/markmap-toolbar@0.2.0/dist/index.umd.min.js"></script><script>(r => {
                setTimeout(r);
              })(() => {
  const {
    markmap,
    mm
  } = window;
  const toolbar = new markmap.Toolbar();
  toolbar.attach(mm);
  const el = toolbar.render();
  el.setAttribute('style', 'position:absolute;bottom:20px;right:20px');
  document.body.append(el);
})</script><script>((getMarkmap, getOptions, data) => {
        const {
          Markmap
        } = getMarkmap();
        window.mm = Markmap.create('svg#mindmap', getOptions == null ? void 0 : getOptions(), data);
      })(() => window.markmap,null,{"t":"heading","d":1,"p":{"lines":[0,1]},"v":"HM代码阅读","c":[{"t":"heading","d":2,"p":{"lines":[2,3]},"v":"关键类的说明","c":[{"t":"heading","d":3,"p":{"lines":[4,5]},"v":"各个类之间的关系图"},{"t":"heading","d":3,"p":{"lines":[8,9]},"v":"TComDataCU"}]},{"t":"heading","d":2,"p":{"lines":[11,12]},"v":"帧间预测","c":[{"t":"heading","d":3,"p":{"lines":[13,14]},"v":"Void TEncSearch::xEstimateMvPredAMVP","c":[{"t":"fence","d":4,"v":"<pre class=\"language-c++\"><code class=\"language-c++\">\n  Void TComDataCU::fillMvpCand ( const UInt partIdx, \n                                const UInt partAddr, \n                                const RefPicList eRefPicList, \n                                const Int refIdx, \n                                AMVPInfo* pInfo ) const\n  {}\n</code></pre>\n"},{"t":"ordered_list","d":4,"p":{"lines":[27,56],"start":1},"v":"","c":[{"t":"list_item","d":5,"p":{"lines":[27,28],"index":1},"v":"1. 空域候选（5选1）","c":[{"t":"bullet_list","d":6,"p":{"lines":[37,41]},"v":"","c":[{"t":"list_item","d":7,"p":{"lines":[37,38]},"v":"scaled"}]},{"t":"bullet_list","d":6,"p":{"lines":[41,51]},"v":"","c":[{"t":"list_item","d":7,"p":{"lines":[41,42]},"v":"终止条件"},{"t":"list_item","d":7,"p":{"lines":[45,46]},"v":"矩形划分需要注意"}]}]},{"t":"list_item","d":5,"p":{"lines":[51,52],"index":2},"v":"2. 时域候选（与Merge类似，2选1）"}]}]},{"t":"heading","d":3,"p":{"lines":[56,57]},"v":"运动搜索"}]},{"t":"heading","d":2,"p":{"lines":[59,60]},"v":"调色板模式 (Palette Mode)","c":[{"t":"heading","d":3,"p":{"lines":[60,61]},"v":"涉及到的开关变量","c":[{"t":"fence","d":4,"v":"<pre class=\"language-c++\"><code class=\"language-c++\">  (&quot;PaletteMode&quot;, m_usePaletteMode, false, &quot;Enable the palette mode (not valid in V1 profiles&quot;)\n  (&quot;PaletteMaxSize&quot;, m_paletteMaxSize, 63u, &quot;Maximum palette size&quot;)\n  (&quot;PaletteMaxPredSize&quot;, m_paletteMaxPredSize, 128u, &quot;Maximum palette predictor size&quot;)\n  (&quot;PalettePredInSPSEnabled&quot;, m_palettePredInSPSEnabled, false, &quot;Transmit palette predictor in SPS&quot;)\n  (&quot;PalettePredInPPSEnabled&quot;, m_palettePredInPPSEnabled, false, &quot;Transmit palette predictor in PPS&quot;)\n</code></pre>\n"}]},{"t":"heading","d":3,"p":{"lines":[69,70]},"v":"一些变量","c":[{"t":"thead","d":5,"p":{"lines":[71,72]},"v":"","c":[{"t":"th","d":7,"p":{"lines":[71,72]},"v":"变量名"},{"t":"th","d":7,"p":{"lines":[71,72]},"v":"含义"}]},{"t":"tbody","d":5,"p":{"lines":[73,74]},"v":"","c":[{"t":"td","d":7,"p":{},"v":"<code>m_indError[pos][paletteIdx]</code>"},{"t":"td","d":7,"p":{},"v":"<code>pos</code>处使用调色板<code>paletteIdx</code>产生的SSE<br /><strong>注意</strong> <code>m_indError[pos]</code>的长度为<code>MAX_PALETTE_SIZE+1</code><br /><code>m_indError[pos][MAX_PALETTE_SIZE-1]</code>记录了使用Escape模式的rdCost<br /><code>m_indError[pos][MAX_PALETTE_SIZE-1]</code>记录了使用Escape模式的SSE"}]}]},{"t":"heading","d":3,"p":{"lines":[77,78]},"v":"整体流程","c":[{"t":"fence","d":4,"v":"<pre class=\"language-flow\"><code class=\"language-flow\">start<span class=\"token operator\">=></span>start<span class=\"token operator\">:</span> 检查完<span class=\"token constant\">IBC</span>模式\nafterIBC<span class=\"token operator\">=></span>operation<span class=\"token operator\">:</span> 检查完<span class=\"token constant\">IBC</span>模式\nisPalette<span class=\"token operator\">=></span>condition<span class=\"token operator\">:</span> 是否使用调色板<span class=\"token operator\">?</span>\ninit1<span class=\"token operator\">=></span>operation<span class=\"token operator\">:</span> 设置调色板中Escape使用的<span class=\"token constant\">QP</span>，允许误差，forcePalettePrediction标志位\ninit2<span class=\"token operator\">=></span>operation<span class=\"token operator\">:</span> 为普通模式和强制使用预测模式的调色板大小分配内存paletteSize<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\nisU32<span class=\"token operator\">=></span>condition<span class=\"token operator\">:</span> <span class=\"token constant\">CU</span>大小是否小于等于<span class=\"token number\">32</span><span class=\"token operator\">?</span>\ncheck0<span class=\"token operator\">=></span>operation<span class=\"token operator\">:</span> 第一次尝试普通模式，将调色板大小存入paletteSize<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>，testedModes<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token function\">xCheckPaletteMode</span><span class=\"token punctuation\">(</span> rpcBestCU<span class=\"token punctuation\">,</span> rpcTempCU<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> iterNumber<span class=\"token punctuation\">,</span> paletteSize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nisLossy<span class=\"token operator\">=></span>condition<span class=\"token operator\">:</span> 有损编码？\nisCheck0<span class=\"token operator\">=></span>condition<span class=\"token operator\">:</span> 第<span class=\"token number\">1</span>次尝试普通模式有效？\ncheck2<span class=\"token operator\">=></span>operation<span class=\"token operator\">:</span> 第二次尝试普通模式，对调色板按照出现次数降序排序，testedModes<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token function\">xCheckPaletteMode</span><span class=\"token punctuation\">(</span> rpcBestCU<span class=\"token punctuation\">,</span> rpcTempCU<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> iterNumber<span class=\"token punctuation\">,</span> paletteSize<span class=\"token punctuation\">)</span>，其中会调用Iter<span class=\"token punctuation\">;</span>\nisForcePred<span class=\"token operator\">=></span>condition<span class=\"token operator\">:</span> 强制使用预测模式？\ncheck1<span class=\"token operator\">=></span>operation<span class=\"token operator\">:</span> 第一次尝试预测模式，将调色板大小存入paletteSize<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>，operation<span class=\"token operator\">:</span>testedModes<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token function\">xCheckPaletteMode</span><span class=\"token punctuation\">(</span> rpcBestCU<span class=\"token punctuation\">,</span> rpcTempCU<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> iterNumber<span class=\"token punctuation\">,</span> paletteSize<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nisCheck1<span class=\"token operator\">=></span>condition<span class=\"token operator\">:</span> 第<span class=\"token number\">1</span>次尝试预测模式有效？\ncheck3<span class=\"token operator\">=></span>operation<span class=\"token operator\">:</span> 第二次尝试预测模式，对调色板按照出现次数降序排序，testedModes<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span><span class=\"token function\">xCheckPaletteMode</span><span class=\"token punctuation\">(</span> rpcBestCU<span class=\"token punctuation\">,</span> rpcTempCU<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> iterNumber<span class=\"token punctuation\">,</span> paletteSize<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>，其中会调用Iter<span class=\"token punctuation\">;</span>\nend<span class=\"token operator\">=></span>end<span class=\"token operator\">:</span> 继续向下划分\n\nstart<span class=\"token operator\">-</span><span class=\"token operator\">></span>isPalette\n<span class=\"token function\">isPalette</span><span class=\"token punctuation\">(</span>no<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span>end\n<span class=\"token function\">isPalette</span><span class=\"token punctuation\">(</span>yes<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>init1\ninit1<span class=\"token operator\">-</span><span class=\"token operator\">></span>init2\ninit2<span class=\"token operator\">-</span><span class=\"token operator\">></span>isU32\n<span class=\"token function\">isU32</span><span class=\"token punctuation\">(</span>no<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>end\n<span class=\"token function\">isU32</span><span class=\"token punctuation\">(</span>yes<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>check0\ncheck0<span class=\"token operator\">-</span><span class=\"token operator\">></span>isLossy\n<span class=\"token function\">isLossy</span><span class=\"token punctuation\">(</span>no<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>end\n<span class=\"token function\">isLossy</span><span class=\"token punctuation\">(</span>yes<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>isCheck0\n<span class=\"token function\">isCheck0</span><span class=\"token punctuation\">(</span>yes<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>check2\n<span class=\"token function\">isCheck0</span><span class=\"token punctuation\">(</span>no<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>check1\ncheck2<span class=\"token operator\">-</span><span class=\"token operator\">></span>isForcePred\n<span class=\"token function\">isForcePred</span><span class=\"token punctuation\">(</span>yes<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>check1\n<span class=\"token function\">isForcePred</span><span class=\"token punctuation\">(</span>no<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>end\ncheck1<span class=\"token operator\">-</span><span class=\"token operator\">></span>isCheck1\n<span class=\"token function\">isCheck1</span><span class=\"token punctuation\">(</span>yes<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>check3\n<span class=\"token function\">isCheck1</span><span class=\"token punctuation\">(</span>no<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>end\ncheck3<span class=\"token operator\">-</span><span class=\"token operator\">></span>end\n\n</code></pre>\n"}]},{"t":"heading","d":3,"p":{"lines":[126,127]},"v":"编码流程","c":[{"t":"fence","d":4,"v":"<pre class=\"language-mermaid\"><code class=\"language-mermaid\">\n</code></pre>\n"}]},{"t":"heading","d":3,"p":{"lines":[134,135]},"v":"构建调色板","c":[{"t":"heading","d":4,"p":{"lines":[136,137]},"v":"普通Lossy","c":[{"t":"fence","d":5,"v":"<pre class=\"language-c++\"><code class=\"language-c++\">Void TEncSearch::xDerivePaletteLossy(\n            TComDataCU* pcCU, \n            Pel* Palette[3], \n            Pel* pSrc[3], \n            UInt width, \n            UInt height, \n            UInt&amp; paletteSize, \n            TComRdCost* pcCost)\n{}\n</code></pre>\n"},{"t":"ordered_list","d":5,"p":{"lines":[149,185],"start":1},"v":"","c":[{"t":"list_item","d":6,"p":{"lines":[149,150],"index":1},"v":"1. 统计颜色直方图并将结果存入 <code>psListHistogram</code> 中"},{"t":"list_item","d":6,"p":{"lines":[151,152],"index":2},"v":"2. 找到颜色直方图中的主导颜色（主导元素的定义为没有其他相似像素的数量大于它的两倍），并将其添加至<code>psList</code>和<code>psInitial</code>中，同时将相似像素归零"},{"t":"list_item","d":6,"p":{"lines":[153,154],"index":3},"v":"3. 遍历所有像素，在<code>psList</code>中为其匹配最佳调色板（针对上一步中不是主导颜色的像素），如果接近则更新主导颜色，否则添加当前颜色"},{"t":"list_item","d":6,"p":{"lines":[155,156],"index":4},"v":"4. 将<code>psSortList</code>按照统计次数降序排序"},{"t":"list_item","d":6,"p":{"lines":[157,158],"index":5},"v":"5. 此步开始构建外部传入指针的调色板<code>Palette</code>，遍历<strong>当前</strong>调色板<code>psSortList</code>中的元素","c":[{"t":"list_item","d":8,"p":{"lines":[158,159]},"v":"对该类像素进行平均后四舍五入取整（由于该类像素包括主导像素和相似像素，故产生误差）并加入<code>Palette</code>中"},{"t":"list_item","d":8,"p":{"lines":[159,160]},"v":"计算RD cost <code>bestCost</code> （像素数量*单个像素产生的误差 + 单个像素的比特数）"},{"t":"list_item","d":8,"p":{"lines":[160,161]},"v":"遍历<strong>预测</strong>调色板中的元素计算RD cost"},{"t":"list_item","d":8,"p":{"lines":[161,162]},"v":"如果小于则替换第一步中的调色板"},{"t":"list_item","d":8,"p":{"lines":[162,163]},"v":"在<code>paletteIndPred</code>中标注<strong>当前</strong>调色板在预测调色板中的标号（&gt;=0为标号，-1为未使用）"},{"t":"list_item","d":8,"p":{"lines":[163,164]},"v":"遍历到最后 只出现一次并且不在<strong>预测</strong>调色板中的 颜色不加入调色板， 出现多次或者在<strong>预测</strong>调色板中 的颜色如果已经存在于<strong>当前</strong>调色板则不用添加"}]},{"t":"list_item","d":6,"p":{"lines":[167,168],"index":6},"v":"6. 遍历每一个像素，初步选择最佳调色板，如果误差小于阈值，则将调色板索引其添加到CU的map<code>m_indexBlock</code>中；如果误差大于阈值，则进行<code>xCalcPixelPredRD</code>，如果进行它之后的RDcost小于调色板，则将其视为孤立像素，<code>m_indexBlock</code>对应位置填入-1","c":[{"t":"paragraph","d":8,"p":{"lines":[169,170]},"v":"此外引入了变量<code>UInt palettePredSamples[MAX_PALETTE_SIZE][5];</code>，在不是YUV400格式的情况下"},{"t":"table","d":8,"p":{"lines":[171,178]},"v":"","c":[{"t":"thead","d":9,"p":{"lines":[171,172]},"v":"","c":[{"t":"th","d":11,"p":{"lines":[171,172]},"v":"变量"},{"t":"th","d":11,"p":{"lines":[171,172]},"v":"含义"}]},{"t":"tbody","d":9,"p":{"lines":[173,178]},"v":"","c":[{"t":"tr","d":10,"p":{},"v":"","c":[{"t":"td","d":11,"p":{},"v":"<code>palettePredSamples[i][0]</code>"},{"t":"td","d":11,"p":{},"v":"使用第<code>i</code>个调色板的次数"}]},{"t":"tr","d":10,"p":{},"v":"","c":[{"t":"td","d":11,"p":{},"v":"<code>palettePredSamples[i][1]</code>"},{"t":"td","d":11,"p":{},"v":"使用第<code>i</code>个调色板的Y分量累加和"}]},{"t":"tr","d":10,"p":{},"v":"","c":[{"t":"td","d":11,"p":{},"v":"<code>palettePredSamples[i][2]</code>"},{"t":"td","d":11,"p":{},"v":"使用第<code>i</code>个调色板的U分量累加和"}]},{"t":"tr","d":10,"p":{},"v":"","c":[{"t":"td","d":11,"p":{},"v":"<code>palettePredSamples[i][3]</code>"},{"t":"td","d":11,"p":{},"v":"使用第<code>i</code>个调色板的V分量累加和"}]},{"t":"tr","d":10,"p":{},"v":"","c":[{"t":"td","d":11,"p":{},"v":"<code>palettePredSamples[i][4]</code>"},{"t":"td","d":11,"p":{},"v":"使用第<code>i</code>个调色板的次数"}]}]}]}]},{"t":"list_item","d":6,"p":{"lines":[179,180],"index":7},"v":"7. 遍历<strong>当前</strong>调色板，再次选择最佳调色板，==关于如何选择<strong>预测</strong>调色板中的最优元素==。","c":[{"t":"list_item","d":8,"p":{"lines":[181,182]},"v":"利用<code>palettePredSamples[i]</code>更新当前调色板，计算RDcost"},{"t":"list_item","d":8,"p":{"lines":[182,183]},"v":"在<strong>预测</strong>调色板中选出Top <code>maxPredCheck</code> 个失真最小的调色板（按照失真从小到大排序），如果<strong>当前</strong>调色板之前添加<strong>预测</strong>调色板的索引不属于Top <code>maxPredCheck</code>，则后续考虑Top <code>maxPredCheck+1</code>"},{"t":"list_item","d":8,"p":{"lines":[183,184]},"v":"遍历Top <code>maxPredCheck+1</code>，然后选出最小的RDcost，更新<strong>当前</strong>调色板中选择的<strong>预测</strong>调色板的索引"}]}]}]},{"t":"heading","d":4,"p":{"lines":[185,186]},"v":"强制使用预测模式Lossy","c":[{"t":"fence","d":5,"v":"<pre class=\"language-c++\"><code class=\"language-c++\">Void TEncSearch::xDerivePaletteLossyForcePrediction(\n    TComDataCU* pcCU, \n    Pel* Palette[3], \n    Pel* pSrc[3], \n    UInt width, UInt height, \n    UInt&amp; paletteSize, \n    TComRdCost* pcCost)\n\n</code></pre>\n"},{"t":"ordered_list","d":5,"p":{"lines":[198,212],"start":1},"v":"","c":[{"t":"list_item","d":6,"p":{"lines":[198,199],"index":1},"v":"1. 遍历每一个像素点，在误差范围内，统计使用各个预测调色板的次数，按照使用次数从多到少填入当前调色板作为初始化"},{"t":"list_item","d":6,"p":{"lines":[200,201],"index":2},"v":"2. 遍历每一个像素点，如果第一步选出的调色板不满足允许误差，则将其添加到临时变量<code>psList</code>中"},{"t":"list_item","d":6,"p":{"lines":[202,203],"index":3},"v":"3. 冒泡排序<code>psList</code>，结果储存在<code>psListSort</code>中"},{"t":"list_item","d":6,"p":{"lines":[204,205],"index":4},"v":"4. 将<code>psListSort</code>中的调色板四舍五入后临时加入到当前调色板中，计算四舍五入后产生的代价，再计算<strong>未</strong>四舍五入后的调色板与当前调色板中其他元素的代价决定是否真正加入"},{"t":"list_item","d":6,"p":{"lines":[208,209],"index":5},"v":"5. 遍历每一个像素点，为每一个像素点选择一个最佳调色板，如果最佳调色板的SSE都要<strong>高于</strong>Escape Mode，那么则将当前点视为游离元素，在<code>m_indexBlock</code>的对应位置-1，否则在<code>palettePredSamples</code>中重新统计该调色板出现的次数等信息，在<code>m_indexBlock</code>的对应位置置调色板索引"},{"t":"list_item","d":6,"p":{"lines":[210,211],"index":6},"v":"6. 遍历当前调色板中的元素，利用<code>palettePredSamples</code>中的信息更新调色板，计算使用该调色板的像素产生的误差<code>minError</code>，在预测调色板中选出与该调色板误差最小的前<code>maxPredCheck</code>个，从小到大将其索引放置在<code>paletteIndBest</code>中，分别计算使用<code>maxPredCheck</code>产生的误差<code>absError</code>，最后如果预测调色板中的误差更小则选择相应的索引更小的预测调色板，<strong>临时</strong>更新当前调色板为预测调色板的元素，如果当前索引之前的调色板有与之相同的，则不更新"}]}]}]},{"t":"heading","d":3,"p":{"lines":[212,213]},"v":"游程模式"}]}]})</script>
</body>
</html>
